/**
 * Created by a.amrastanov on 08.11.2014.
 */
var net = require('net');
var port = 80;
var host = 'gw.maradit.net';
var out = require('out');
var requestHeaders =  "POST /api/json/syncreply/submit HTTP/1.1\r\n" +
    "Host: gw.maradit.net\r\n"+
    "Content-Type: application/json;\r\n";
var requestContentLength = "Content-Length: ";
var requestConnection = "Connection: close\r\n\r\n";
var messageBody = {
    Credential: {"Username": "teztaxi", "Password": "1738tezapp"},
    DataCoding: "Default",
    Header: {"From": "Tez-Taxi", "ScheduledDeliveryTime": "0000-00-00T00:00:00Z", "ValidityPeriod": "1440"},
    Message: "",
    "To": []
};
var phonePrefix = "994";

var SMSService = {
  send: function(addressUser, dataUser){
      var sock = new net.Socket();
      sock.connect(port, host, function() {
          messageBody.Message = require('charDecoder')(dataUser.getSmsData());
          messageBody.To = [phonePrefix + addressUser.data.phone];
          out.info('SMS Socket connected. To: ' +  addressUser.data.token + ', data user: ' + dataUser.data.token);
          var requestText = JSON.stringify(messageBody);
          var messageText = requestHeaders + requestContentLength + requestText.length + "\r\n" + requestConnection + requestText;
          sock.write(messageText);
          out.action("Sent to" + addressUser.data.token + ": " + messageText);
      });

      sock.on('data', function(data) {
          out.action('SMS Socket receive('+data+'): To: ' +  addressUser.data.token + ', data user: ' + dataUser.data.token);
          sock.end();
          sock.destroy();
      });
      sock.on('close', function() {
          out.info('SMS Socket closed. To: ' +  addressUser.data.token + ', data user: ' + dataUser.data.token);
      });
      sock.on('error', function(err) {
          out.error('SMS Socket error ('+err+'). To: ' +  addressUser.data.token + ', data user: ' + dataUser.data.token);
      });

  }
};

module.exports = SMSService;
