/**
 * Created by a.amrastanov on 06.08.2014.
 */

module.exports = function(parameterMap){
    this.action = parameterMap.action;
    this.order = parameterMap.order;
    this.reason = parameterMap.reason;
    this.doAction = function(){
        var messageBody = require('contextHandler').NewMessageBody(this.action, {reason: this.reason});
        var client = this.order.getClient();
        if (client){
            require('services').gcmService.send(client,  messageBody, 'orderRefuse');
            client.removeOrder();
        }
        else{
            var order = this.order;
            require('db').clientDB.getById(this.order.data.clientId, function (err, userData) {
                if (err){
                    require('out').error('error on get user data', err, 'sendOrderRefuseToClient', order);
                }
                else{
                    var UserConstructor = require('userHandler').clientHandler.userConstructor;
                    var user = new UserConstructor(userData);
                    require('services').gcmService.send(user, messageBody, 'orderRefuse');
                    user.removeOrder();
                }
            });
        }
    }
};
