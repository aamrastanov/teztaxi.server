/**
 * Created by Администратор on 09.01.2015.
 */

module.exports = function(parameterMap){
    this.action = parameterMap.action;
    this.order = parameterMap.order;
    this.doAction = function(){
        var messageBody = require('contextHandler').NewMessageBody(this.action,
            {orderId: this.order.data.id, timestamp: new Date().getTime()});
        var client = this.order.getClient();
        if (client){
            require('services').gcmService.send(client,  messageBody, 'clientDontCome');
            client.removeOrder();
        }
        else{
            var order = this.order;
            require('db').clientDB.getById(this.order.data.clientId, function (err, userData) {
                if (err){
                    require('out').error('error on get user data', err, 'sendClientDontComeToClient', order);
                }
                else{
                    var UserConstructor = require('userHandler').clientHandler.userConstructor;
                    var user = new UserConstructor(userData);
                    require('services').gcmService.send(user, messageBody, 'clientDontCome');
                    user.removeOrder();
                }
            });
        }
    }
};

