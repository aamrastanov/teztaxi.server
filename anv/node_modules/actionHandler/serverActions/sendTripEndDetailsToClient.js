/**
 * Created by a.amrastanov on 29.09.2014.
 */

module.exports = function(parameterMap){
    this.action = parameterMap.action;
    this.order = parameterMap.order;
    this.doAction = function() {
        var messageBody = require('contextHandler').NewMessageBody(this.action,
            {orderId: this.order.data.id, timestamp: new Date().getTime()});
        var client = this.order.getClient();
        if (client){
            require('services').gcmService.send(client, messageBody, 'tripEnd');
            client.removeOrder();
        }
        else{
            var order = this.order;
            require('db').clientDB.getById(order.data.clientId, function (err, userData) {
                if (err){
                    require('out').error('error on get user data', err, 'sendTripEndDetailsToClient', order);
                }
                else{
                    var UserConstructor = require('userHandler').clientHandler.userConstructor;
                    var user = new UserConstructor(userData);
                    require('services').gcmService.send(user, messageBody, 'tripEnd');
                    user.removeOrder();
                }
            });
        }
    }
};