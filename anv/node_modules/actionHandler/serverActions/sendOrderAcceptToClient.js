/**
 * Created by a.amrastanov on 06.08.2014.
 */

module.exports = function(parameterMap){
    this.action = parameterMap.action;
    this.time = parameterMap.time;
    this.order = parameterMap.order;
    this.doAction = function(){
        var messageBody = require('contextHandler').NewMessageBody(this.action, {time: this.time})
        var client = this.order.getClient();
        if (client === undefined){
            var order = this.order;
            require('db').clientDB.getById(order.data.clientId, function (err, userData) {
                if (err){
                    require('out').error('error on get user data', err, 'sendOrderAcceptToClient', order);
                }
                else{
                    var UserConstructor = require('userHandler').clientHandler.userConstructor;
                    var user = new UserConstructor(userData);
                    require('services').gcmService.send(user, messageBody, 'orderAccept');
                    user.updateState(require('userHandler').WORK_STATE.BEFORE_TRIP);
                }
            });
        }
        else{
            client.updateState(require('userHandler').WORK_STATE.BEFORE_TRIP, function(updatedUser){
                require('services').gcmService.send(updatedUser, messageBody, 'orderAccept');
            });
        }
    }
};
